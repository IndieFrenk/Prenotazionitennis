<!-- Page header -->
<app-header />

<main class="reset-password-page">
  <div class="reset-container">
    <p-card styleClass="reset-card">
      <!-- Card header -->
      <ng-template pTemplate="header">
        <div class="card-header">
          <i class="pi pi-key"></i>
          <h1>Reimposta password</h1>
          <p>Inserisci la tua nuova password</p>
        </div>
      </ng-template>

      <!-- Missing token state -->
      @if (tokenMissing) {
        <div class="error-state">
          <i class="pi pi-exclamation-triangle"></i>
          <p>Link di reset non valido. Il token è mancante.</p>
          <p-button
            label="Richiedi nuovo link"
            icon="pi pi-refresh"
            routerLink="/recupera-password"
            severity="primary"
            [outlined]="true"
          />
        </div>
      }

      <!-- Form state -->
      @if (!tokenMissing) {
        <!-- Error message -->
        @if (errorMessage) {
          <p-message severity="error" [text]="errorMessage" styleClass="w-full mb-3" />
        }

        <form [formGroup]="resetForm" (ngSubmit)="onSubmit()">
          <!-- New password field -->
          <div class="field">
            <label for="password">Nuova password</label>
            <p-password
              id="password"
              formControlName="password"
              placeholder="Almeno 8 caratteri"
              [toggleMask]="true"
              [feedback]="true"
              styleClass="w-full"
              inputStyleClass="w-full"
              promptLabel="Inserisci una password"
              weakLabel="Debole"
              mediumLabel="Media"
              strongLabel="Forte"
            />
            @if (isFieldInvalid('password')) {
              <small class="p-error">
                @if (resetForm.get('password')?.hasError('required')) {
                  La password è obbligatoria.
                } @else if (resetForm.get('password')?.hasError('minlength')) {
                  La password deve contenere almeno 8 caratteri.
                }
              </small>
            }
          </div>

          <!-- Confirm password field -->
          <div class="field">
            <label for="confirmPassword">Conferma nuova password</label>
            <p-password
              id="confirmPassword"
              formControlName="confirmPassword"
              placeholder="Ripeti la nuova password"
              [feedback]="false"
              [toggleMask]="true"
              styleClass="w-full"
              inputStyleClass="w-full"
            />
            @if (isFieldInvalid('confirmPassword')) {
              <small class="p-error">
                La conferma password è obbligatoria.
              </small>
            }
            @if (hasPasswordMismatch()) {
              <small class="p-error">
                Le password non coincidono.
              </small>
            }
          </div>

          <!-- Submit button -->
          <p-button
            type="submit"
            label="Reimposta password"
            icon="pi pi-check"
            severity="primary"
            styleClass="w-full"
            [loading]="submitting"
            [disabled]="submitting"
          />
        </form>
      }

      <!-- Back to login link -->
      <ng-template pTemplate="footer">
        <div class="back-link">
          <a routerLink="/login">
            <i class="pi pi-arrow-left"></i>
            Torna al login
          </a>
        </div>
      </ng-template>
    </p-card>
  </div>
</main>

<!-- Page footer -->
<app-footer />
