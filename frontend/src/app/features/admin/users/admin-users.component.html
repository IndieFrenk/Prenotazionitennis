<!-- Admin Users List -->
<p-toast />
<p-confirmDialog />

<div class="admin-users">
  <!-- Page header -->
  <div class="page-header">
    <div class="page-header__left">
      <h1>Gestione Utenti</h1>
      <p class="page-subtitle">Visualizza e gestisci gli utenti del club</p>
    </div>
  </div>

  <!-- Search and filters bar -->
  <div class="filters-bar">
    <div class="search-group">
      <span class="p-input-icon-left">
        <i class="pi pi-search"></i>
        <input
          type="text"
          pInputText
          [ngModel]="searchTerm"
          (ngModelChange)="onSearchInput($event)"
          placeholder="Cerca per nome utente o email..."
          class="search-input"
        />
      </span>
    </div>
    <span class="user-count">
      {{ totalRecords }} utente/i trovato/i
    </span>
  </div>

  <!-- Loading spinner -->
  @if (loading) {
    <div class="loading-container">
      <p-progressSpinner strokeWidth="4" animationDuration="1s" />
      <p>Caricamento utenti...</p>
    </div>
  }

  <!-- Users data table -->
  @if (!loading && users.length > 0) {
    <p-table
      [value]="users"
      [paginator]="false"
      styleClass="p-datatable-striped"
      [tableStyle]="{ 'min-width': '70rem' }"
      [responsive]="true"
    >
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="username">
            Username
            <p-sortIcon field="username" />
          </th>
          <th pSortableColumn="email">
            Email
            <p-sortIcon field="email" />
          </th>
          <th style="width: 10rem">Ruolo</th>
          <th style="width: 8rem">Stato</th>
          <th style="width: 10rem">Data registrazione</th>
          <th style="width: 20rem">Azioni</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-user>
        <tr>
          <!-- Username -->
          <td>
            <span class="user-username">{{ user.username }}</span>
          </td>

          <!-- Email -->
          <td>
            <span class="user-email">{{ user.email }}</span>
          </td>

          <!-- Role tag -->
          <td>
            <p-tag
              [value]="getRoleLabel(user.role)"
              [severity]="getRoleSeverity(user.role)"
            />
          </td>

          <!-- Status tag -->
          <td>
            <p-tag
              [value]="getStatusLabel(user.accountStatus)"
              [severity]="getStatusSeverity(user.accountStatus)"
            />
          </td>

          <!-- Registration date -->
          <td>
            <span class="user-date">{{ user.createdAt | date:'dd/MM/yyyy' }}</span>
          </td>

          <!-- Action buttons -->
          <td>
            <div class="action-buttons">
              <!-- Role change dropdown -->
              <p-dropdown
                [options]="roleOptions"
                [ngModel]="user.role"
                (ngModelChange)="confirmRoleChange(user, $event)"
                placeholder="Cambia ruolo"
                [style]="{ 'min-width': '10rem' }"
                appendTo="body"
              />

              <!-- Toggle status button -->
              <button
                pButton
                type="button"
                [label]="getToggleLabel(user.accountStatus)"
                [icon]="getToggleIcon(user.accountStatus)"
                [severity]="getToggleSeverity(user.accountStatus)"
                class="p-button-sm p-button-outlined"
                (click)="confirmToggleStatus(user)"
              ></button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="summary">
        <div class="table-summary">
          Pagina {{ currentPage + 1 }} - Totale: {{ totalRecords }} utente/i
        </div>
      </ng-template>
    </p-table>

    <!-- Paginator -->
    @if (totalRecords > pageSize) {
      <p-paginator
        [rows]="pageSize"
        [totalRecords]="totalRecords"
        [rowsPerPageOptions]="[10, 25, 50]"
        [first]="currentPage * pageSize"
        (onPageChange)="onPageChange($event)"
      />
    }
  }

  <!-- Empty state -->
  @if (!loading && users.length === 0) {
    <div class="empty-state">
      <i class="pi pi-users"></i>
      @if (searchTerm) {
        <p>Nessun utente trovato per "{{ searchTerm }}".</p>
      } @else {
        <p>Nessun utente registrato.</p>
      }
    </div>
  }
</div>
